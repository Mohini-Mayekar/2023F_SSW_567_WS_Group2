<!DOCTYPE html>
<html>
<head>
    <title>MutPy mutation report - mutation #41</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    
<link href="http://alexgorbatchev.com/pub/sh/current/styles/shCore.css" rel="stylesheet" type="text/css" />
<link href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" rel="stylesheet" type="text/css" />

    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js" type="text/javascript"></script>
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushPython.js" type="text/javascript"></script>
<script type="text/javascript">
    SyntaxHighlighter.all();
    window.setTimeout(function () {
        
        $('.line.number270').attr('title', 'AOR');
        
    }, 0);
</script>

</head>
<body>
    <div class="container">
        
<div class="page-header">
    <h1>Mutation #41</h1>
</div>
<h3>Details</h3>
<ul>
    <li>module - <code><module 'MRTD' from 'C:\\Users\\Anlan\\OneDrive\\PhD Years\\Courses\\Fall 2023\\SYS567WS\\Final Project\\Group 2\\2023F_SSW_567_WS_Group2\\MRTD.py'></code></li>
    <li><span class="label label-danger">survived</span></li>
    
    <li>duration - 0.209 s</li>
    
    
    <li>tests run - 16</li>
    
</ul>

<h3>Mutations</h3>
<ul>
    
    <li>AOR - line 270</li>
    
</ul>
<h3>Mutant</h3>
<pre class="brush: python; first-line: 1; highlight: [270]; toolbar: false;">'''Module - encoding and decoding MRZ'''

from contants import CHECK_DIGIT_VERIFICATION_FAILED, CHECK_DIGIT_VERIFICATION_FAILED_DETAILS



import json

def scan_mrz():
    '''logic to scan MRZ and return two strings - blank function'''






def get_mrz_details_from_db():
    '''logic to get MRTD information from DB - blank function'''




def decode_mrz_recs(encoded_recs_json):
    '''Decode multiple MRZ recs'''
    print(type(encoded_recs_json))
    try:
        decoded_json_list = []
        
        
        if (isinstance(encoded_recs_json, dict) and 'records_encoded' in encoded_recs_json):
            encoded_recs = encoded_recs_json['records_encoded']
        else:
            
            encoded_recs = encoded_recs_json
        
        for rec in encoded_recs:
            
            if isinstance(rec, str):
                mrz_str_list = rec.split(';')
                mrz_str_ln_1 = mrz_str_list[0]
                mrz_str_ln_2 = mrz_str_list[1]
                decoded_json_list.append(decode_mrz(mrz_str_ln_1, mrz_str_ln_2))
            elif isinstance(rec, dict):
                
                decoded_json_list.append(rec)
        
        return decoded_json_list
    
    except TimeoutError:
        print('TimeoutError - in decode_mrz_recs')


def decode_mrz(mrz_str_ln_1, mrz_str_ln_2):
    '''Decode a MRZ string'''
    try:
        check_digit_errors = []
        
        mrz_str_ln_1_list = mrz_str_ln_1.split('<')
        
        
        issuing_country = mrz_str_ln_1_list[1][:3]
        last_name = mrz_str_ln_1_list[1][3:]
        first_name = mrz_str_ln_1_list[3]
        middle_name = mrz_str_ln_1_list[4]
        given_name = (first_name + ' ') + middle_name
        
        line_1_json_str = \
            ((((('{"issuing_country": "' + \
            issuing_country) + \
            '", "last_name": "') + \
            last_name) + \
            '", "given_name": "') + \
            given_name) + \
            '"}'
        
        
        
        mrz_str_ln_2_list = mrz_str_ln_2.split('<')
        
        
        
        
        
        mrz_str_ln_2_0 = mrz_str_ln_2_list[0]
        doc_number = mrz_str_ln_2_0[:9]
        doc_check_digit = mrz_str_ln_2_0[9:10]
        calc_doc_check_digit = calculate_check_digit(doc_number)
        if doc_check_digit != calc_doc_check_digit:
            check_digit_errors.append(
                (\
                'passport number', \
                doc_number, \
                calc_doc_check_digit, \
                doc_check_digit))
        
        
        country_code = mrz_str_ln_2_0[10:13]
        birth_date = mrz_str_ln_2_0[13:19]
        birth_date_check_digit = mrz_str_ln_2_0[19:20]
        calc_birth_date_check_digit = calculate_check_digit(birth_date)
        if birth_date_check_digit != calc_birth_date_check_digit:
            check_digit_errors.append(
                (\
                'birth date', \
                birth_date, \
                calc_birth_date_check_digit, \
                birth_date_check_digit))
        
        
        gender = mrz_str_ln_2_0[20:21]
        expiration_date = mrz_str_ln_2_0[21:27]
        expiration_date_check_digit = mrz_str_ln_2_0[27:28]
        calc_expiration_date_check_digit = calculate_check_digit(expiration_date)
        if expiration_date_check_digit != calc_expiration_date_check_digit:
            check_digit_errors.append(
                (\
                'expiration date', \
                expiration_date, \
                calc_doc_check_digit, \
                expiration_date_check_digit))
        
        
        personal_number = mrz_str_ln_2_0[28:]
        personal_number_check_digit = mrz_str_ln_2_list[6]
        calc_personal_number_check_digit = calculate_check_digit(personal_number)
        if personal_number_check_digit != calc_personal_number_check_digit:
            check_digit_errors.append(
                (\
                'personal number', \
                personal_number, \
                calc_personal_number_check_digit, \
                personal_number_check_digit))
        
        
        
        line_2_json_str = \
            ((((((((((('{"passport_number": "' + \
            doc_number) + \
            '", "country_code": "') + \
            country_code) + \
            '", "birth_date": "') + \
            birth_date) + \
            '", "sex": "') + \
            gender) + \
            '", "expiration_date": "') + \
            expiration_date) + \
            '", "personal_number": "') + \
            personal_number) + \
            '"}'
        
        
        json_str = ((('{"line1": ' + line_1_json_str) + ',"line2": ') + line_2_json_str) + '}'
        
        if check_digit_errors:
            raise ValueError(CHECK_DIGIT_VERIFICATION_FAILED, check_digit_errors)
        
        return json_str
    
    except ValueError as e:
        
        if (len(e.args) > 1 and isinstance(e.args[1], list)):
            
            check_digit_errors = e.args[1]
            for error in check_digit_errors:
                print(
                    CHECK_DIGIT_VERIFICATION_FAILED_DETAILS.format(
                    field=error[0], 
                    value=error[1], 
                    expected=error[2], 
                    received=error[3]))
    
    
    except TimeoutError:
        print('TimeoutError - in decode_mrz')


def encode_mrz_recs(decoded_recs_json):
    '''Encode multiple MRZ recs'''
    try:
        
        if 'records_decoded' in decoded_recs_json:
            decoded_recs = decoded_recs_json['records_decoded']
        else:
            decoded_recs = decoded_recs_json
        
        encoded_json_list = []
        for rec in decoded_recs:
            if isinstance(rec, str):
                
                try:
                    rec = json.loads(rec)
                except json.JSONDecodeError:
                    print(f'Error decoding JSON: {rec}')
                    continue
            
            (encoded_line_1, encoded_line_2) = encode_mrz(rec)
            encoded_json_list.append((encoded_line_1 + ';') + encoded_line_2)
        return encoded_json_list
    
    except TimeoutError:
        print('TimeoutError - in encode_mrz_recs')



def encode_mrz(rec):
    '''Encode a MRZ string'''
    try:
        rec_line_1 = rec['line1']
        issuing_country = rec_line_1['issuing_country']
        last_name = rec_line_1['last_name']
        given_name = rec_line_1['given_name']
        
        if given_name.find(' ') != -1:
            name = given_name.split(' ')
            first_name = name[0]
            middle_name = name[1]
        else:
            first_name = given_name
            middle_name = ''
        
        
        line_1 = ('P', issuing_country + last_name, first_name, middle_name)
        encoded_line_1 = \
            f'{line_1[0]}<{line_1[1]}<<{line_1[2]}<{line_1[3]}<<<<<<<<<<<<<<<<<<<<<<'
        
        
        
        
        rec_line_2 = rec['line2']
        passport_number = rec_line_2['passport_number']
        doc_check_digit = calculate_check_digit(passport_number)
        country_code = rec_line_2['country_code']
        birth_date = rec_line_2['birth_date']
        birth_date_check_digit = calculate_check_digit(birth_date)
        gender = rec_line_2['sex']
        expiration_date = rec_line_2['expiration_date']
        expiration_date_check_digit = calculate_check_digit(expiration_date)
        personal_number = rec_line_2['personal_number']
        personal_number_check_digit = calculate_check_digit(personal_number)
        
        
        line_2 = (\
            (((((((passport_number + \
            doc_check_digit) + \
            country_code) + \
            birth_date) + \
            birth_date_check_digit) + \
            gender) + \
            expiration_date) + \
            expiration_date_check_digit) + \
            personal_number, \
            personal_number_check_digit)
        
        encoded_line_2 = f'{line_2[0]}<<<<<<{line_2[1]}'
        
        
        
        return (encoded_line_1, encoded_line_2)
    
    except TimeoutError:
        print('TimeoutError - in encode_mrz')


def calculate_check_digit(data):
    '''Calculate check digit for data as per the algorithm provided in the project description'''
    weighting = [7, 3, 1] * 3
    sum_of_products = 0
    for (i, char) in enumerate(data):
        if char.isalpha():
            numeric_val = (ord(char) + ord('A')) + 10
            assigned_numeric_value = numeric_val
        elif char.isnumeric():
            assigned_numeric_value = int(char)
        else:
            assigned_numeric_value = int(0)
        
        sum_of_products += assigned_numeric_value * weighting[i]
    
    
    
    
    return str(sum_of_products % 10)</pre>

    </div>
</body>
</html>